<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fractal Atlas - Infinity</title>
    <style>
        :root { --bg: #050505; --accent: #00d2ff; --text: #eee; --glass: rgba(15, 15, 15, 0.9); --border: 1px solid #333; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; user-select: none; -webkit-user-select: none; touch-action: none; }

        /* HEADER */
        header { height: 45px; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; background: #000; border-bottom: var(--border); z-index: 100; position: relative; }
        #back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 10px;}
        .mode-tabs { display: flex; gap: 5px; }
        .tab-btn { background: #222; border: 1px solid #444; color: #888; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 0 10px; }

        /* VIEWPORT */
        #viewport { display: flex; height: calc(100vh - 175px); width: 100%; position: relative; border-bottom: var(--border); }
        .canvas-container { flex: 1; position: relative; border-right: var(--border); overflow: hidden; background: #000; }
        canvas { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .cvs-cpu { z-index: 5; opacity: 0; pointer-events: none; transition: opacity 0.2s;} 
        .mode-nebula #cpu-left, .mode-nebula #cpu-right, .mode-atlas #cpu-right { opacity: 1; pointer-events: auto; }
        .view-label { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 4px; font-size: 10px; pointer-events: none; z-index: 10; font-weight: bold; letter-spacing: 1px;}

        /* FLOATING INFO */
        #info-overlay { position: absolute; bottom: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; pointer-events: none; z-index: 20; }
        .tag { background: rgba(0,0,0,0.8); padding: 4px 8px; font-size: 10px; border: var(--border); border-radius: 4px; color: #aaa; font-family: monospace; pointer-events: auto;}
        .tag-lock { color: var(--accent); border-color: var(--accent); display: none; }

        /* BOTTOM CONTROLS (PC OPTIMIZED) */
        #bottom-panel { height: 130px; background: #080808; display: flex; padding: 10px; gap: 20px; overflow-x: auto; align-items: center; }
        .ctrl-column { min-width: 180px; display: flex; flex-direction: column; gap: 8px; }
        
        /* SLIDE-OUT SETTINGS (MOBILE OPTIMIZED) */
        #settings-menu { 
            position: absolute; top: 45px; right: 0; bottom: 0; width: 300px; 
            background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-left: var(--border); transform: translateX(100%); transition: transform 0.3s ease;
            z-index: 200; display: flex; flex-direction: column;
        }
        #settings-menu.open { transform: translateX(0); }
        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* SHARED CONTROL STYLES */
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 9px; color: #888; text-transform: uppercase; font-weight: bold; }
        .val-disp { float: right; color: var(--accent); }
        input[type="range"] { width: 100%; height: 4px; background: #333; appearance: none; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 1px solid white; }
        select, input[type="text"], input[type="number"] { background: #111; border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; font-size: 11px; }
        
        .action-btn { background: #333; color: white; border: 1px solid #555; padding: 8px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .action-btn:hover { background: #444; }

        .hidden { display: none !important; }

        /* SAVE MODAL */
        #save-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal-box { background: #111; border: var(--border); padding: 25px; width: 300px; border-radius: 10px; }

        @media (max-width: 800px) {
            #viewport { height: calc(100vh - 100px); flex-direction: column; }
            #bottom-panel { display: none; } /* Hide bottom on mobile, use side menu */
            .canvas-container { border-right: none; border-bottom: var(--border); }
            #settings-menu { width: 80%; }
        }
    </style>
</head>
<body id="app-body">

<header>
    <button id="back-btn" onclick="window.parent.goBack()">&#8592;</button>
    <div class="mode-tabs">
        <button class="tab-btn active" onclick="app.setMode(0)">FRACTALS</button>
        <button class="tab-btn" onclick="app.setMode(1)">NEBULAE</button>
        <button class="tab-btn" onclick="app.setMode(2)">ATLAS</button>
    </div>
    <button class="icon-btn" onclick="ui.toggleSettings()">‚öôÔ∏è</button>
</header>

<div id="viewport">
    <div class="canvas-container" id="cont-left">
        <div class="view-label" id="lbl-left">Mandelbrot</div>
        <canvas id="gl-left"></canvas>
        <canvas id="cpu-left" class="cvs-cpu"></canvas>
    </div>
    <div class="canvas-container" id="cont-right">
        <div class="view-label" id="lbl-right">Julia Set</div>
        <canvas id="gl-right"></canvas>
        <canvas id="cpu-right" class="cvs-cpu"></canvas>
    </div>
    <div id="info-overlay">
        <div class="tag" id="tag-coords">C: -0.7600, 0.1200</div>
        <div class="tag tag-lock" id="tag-lock">üîí SEED LOCKED</div>
    </div>
</div>

<!-- BOTTOM BAR (PC) -->
<div id="bottom-panel">
    <div class="ctrl-column">
        <label>Equation</label>
        <select class="sync-eq" onchange="app.loadPreset(this.value)">
            <option value="z^2 + c">Mandelbrot</option>
            <option value="z^3 + c">Cubic</option>
            <option value="z^5 + c">Quintic</option>
            <option value="burningship">Burning Ship</option>
            <option value="tricorn">Tricorn</option>
        </select>
        <input type="text" class="sync-eq-raw" value="z^2 + c">
    </div>
    <div class="ctrl-column">
        <label>Iterations <span class="val-iter-txt val-disp">300</span></label>
        <input type="range" class="sync-iter" min="50" max="10000" value="300">
        <label>Zoom Speed</label>
        <input type="range" class="sync-zoom-spd" min="0.1" max="5.0" step="0.1" value="1.0">
    </div>
    <div class="ctrl-column grp-std">
        <label>Palette</label>
        <select class="sync-pal">
            <option value="0">Magma</option>
            <option value="1">Viridis</option>
            <option value="2">Ice</option>
            <option value="3">Electric</option>
        </select>
    </div>
    <div class="ctrl-column grp-neb hidden">
        <label>Brightness</label>
        <input type="range" class="sync-den" min="0.1" max="5.0" step="0.1" value="1.5">
    </div>
    <div class="ctrl-column grp-atlas hidden">
        <label>Grid Size <span class="val-grid-txt val-disp">10</span></label>
        <input type="range" class="sync-grid" min="2" max="100" value="10">
    </div>
    <div class="ctrl-column">
        <button class="action-btn" style="background:var(--accent); color:black" onclick="app.compile()">Apply Eq</button>
        <button class="action-btn" onclick="app.resetPos()">Reset Pos</button>
    </div>
</div>

<!-- SIDE MENU (MOBILE) -->
<div id="settings-menu">
    <div class="settings-content">
        <h3>Settings</h3>
        <div class="control-group">
            <label>Equation</label>
            <select class="sync-eq" onchange="app.loadPreset(this.value)">
                <option value="z^2 + c">Mandelbrot</option>
                <option value="z^3 + c">Cubic</option>
                <option value="z^5 + c">Quintic</option>
                <option value="burningship">Burning Ship</option>
                <option value="tricorn">Tricorn</option>
            </select>
            <input type="text" class="sync-eq-raw" value="z^2 + c" style="margin-top:5px;">
            <button class="action-btn" style="background:var(--accent); color:black; margin-top:5px;" onclick="app.compile()">Update Equation</button>
        </div>
        <hr style="border:none; border-bottom:1px solid #333; margin:15px 0;">
        <div class="control-group">
            <label>Max Iterations <span class="val-iter-txt val-disp">300</span></label>
            <input type="range" class="sync-iter" min="50" max="10000" value="300">
        </div>
        <div class="control-group grp-std">
            <label>Color Palette</label>
            <select class="sync-pal">
                <option value="0">Magma</option>
                <option value="1">Viridis</option>
                <option value="2">Ice</option>
                <option value="3">Electric</option>
            </select>
        </div>
        <div class="control-group grp-neb hidden">
            <label>Nebula R/G/B Thresholds</label>
            <input type="range" class="sync-red" min="0" max="1000" value="200" style="accent-color:#ff4444">
            <input type="range" class="sync-grn" min="0" max="1000" value="100" style="accent-color:#00ff00; margin-top:5px;">
            <input type="range" class="sync-blu" min="0" max="1000" value="50" style="accent-color:#0088ff; margin-top:5px;">
        </div>
        <div class="control-group grp-atlas hidden">
            <label>Grid Size <span class="val-grid-txt val-disp">10</span></label>
            <input type="range" class="sync-grid" min="2" max="100" value="10">
        </div>
        <button class="action-btn" onclick="ui.toggleModal(true)">Save High-Res</button>
        <button class="action-btn" onclick="app.resetPos()">Reset Position</button>
        <div style="height:100px;"></div>
    </div>
</div>

<!-- SAVE MODAL -->
<div id="save-modal">
    <div class="modal-box">
        <h3>Save Render</h3>
        <label>View</label>
        <select id="save-view"><option value="left">Left Window</option><option value="right">Right Window</option></select>
        <label style="margin-top:10px;">Res</label>
        <select id="save-res" onchange="ui.checkCustom()">
            <option value="1">Preview</option><option value="2">HD</option><option value="4">4K</option><option value="custom">Custom...</option>
        </select>
        <div id="custom-res" class="hidden" style="margin-top:10px; display:flex; gap:5px;">
            <input type="number" id="save-w" value="3840"> x <input type="number" id="save-h" value="2160">
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="action-btn" style="flex:1" onclick="ui.toggleModal(false)">Cancel</button>
            <button class="action-btn" style="flex:1; background:var(--accent); color:000" onclick="app.save()">Download</button>
        </div>
    </div>
</div>

<script>
// =======================================================
// CORE MODULES
// =======================================================
function parseEquation(eq) {
    let s = eq.toLowerCase().replace(/\s+/g, '');
    app.state.p.eqMode = 0;
    if (s==='z^3+c') app.state.p.eqMode=1; else if (s==='z^4+c') app.state.p.eqMode=2;
    else if (s==='z^5+c') app.state.p.eqMode=3; else if (s==='burningship') app.state.p.eqMode=4;
    else if (s==='tricorn') app.state.p.eqMode=5;
    if(s==='burningship') return 'vec2(z.x*z.x-z.y*z.y, 2.0*abs(z.x*z.y))+c';
    if(s==='tricorn') return 'vec2(z.x*z.x-z.y*z.y, -2.0*z.x*z.y)+c';
    s = s.replace(/z\^2(?!\.)/g, 'vec2(z.x*z.x-z.y*z.y, 2.0*z.x*z.y)');
    s = s.replace(/z\^([0-9.]+)/g, (m,p1)=>p1.includes('.')?`cpow(z,${p1})`:`cpow(z,${p1}.0)`);
    return s;
}

const GL = {
    setup: (id) => {
        const cvs = document.getElementById(id), gl = cvs.getContext('webgl', {preserveDrawingBuffer:true});
        const vs = `attribute vec2 p; void main(){gl_Position=vec4(p,0,1);}`;
        const fsHead = `
            precision highp float;
            vec2 cpow(vec2 z, float n) { float r=length(z); if(r<1e-5)return vec2(0); float a=atan(z.y,z.x); return pow(r,n)*vec2(cos(a*n),sin(a*n)); }
            vec3 pal(float t, int id) { vec3 c=vec3(1),d; if(id==0)d=vec3(0.3,0.2,0.2); else if(id==1)d=vec3(0.0,0.33,0.67); else if(id==2){c=vec3(0.8);d=vec3(0.15,0.2,0.3);} else{c=vec3(2.);d=vec3(0.5,0.2,0.25);} return vec3(0.5)+vec3(0.5)*cos(6.283*(c*t+d)); }
        `;
        const fsBody = `
            uniform vec2 u_res, u_off, u_c; uniform float u_zoom, u_grid, u_iter; uniform int u_mode, u_view, u_pal;
            void main() {
                vec2 uv = (gl_FragCoord.xy - 0.5*u_res)/u_res.y;
                vec2 z, c; vec2 p = uv/u_zoom + u_off;
                if(u_mode==2) {
                    float ts = 1.0/(u_grid*0.25);
                    vec2 cell = floor(p / ts);
                    c = (cell + 0.5) * ts * 4.0;
                    z = ((p - (cell+0.5)*ts) / ts) * 3.0;
                } else {
                    if(u_view==1) { z=p*3.0; c=u_c; } else { z=vec2(0); c=p*4.0; }
                }
                float i=0., m=0.;
                for(int k=0; k<10000; k++) {
                    if(float(k)>u_iter) break;
                    z = {{EQ}}; m=dot(z,z); if(m>100.) break; i+=1.;
                }
                vec3 col = vec3(0);
                if(m>=100.) col = pal((i-log2(log2(m))+4.)*0.03, u_pal);
                if(u_view==0 && u_mode!=2) {
                    if(length((u_c/4.0-u_off)*u_zoom - uv) < 0.01) col = vec3(1);
                }
                gl_FragColor = vec4(col,1);
            }
        `;
        return {gl, cvs, fsHead, fsBody, vs, prog:null};
    },
    compile: (ctx, eq) => {
        const fs = ctx.fsHead + ctx.fsBody.replace('{{EQ}}', eq);
        const gl=ctx.gl, p=gl.createProgram();
        const s = (t,src)=>{const x=gl.createShader(t); gl.shaderSource(x,src); gl.compileShader(x); return gl.getShaderParameter(x,gl.COMPILE_STATUS)?x:gl.getShaderInfoLog(x);};
        const v=s(gl.VERTEX_SHADER, ctx.vs), f=s(gl.FRAGMENT_SHADER, fs);
        if(typeof f==='string') return f;
        gl.attachShader(p,v); gl.attachShader(p,f); gl.linkProgram(p);
        const b=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,b); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW);
        const l=gl.getAttribLocation(p,'p'); gl.enableVertexAttribArray(l); gl.vertexAttribPointer(l,2,gl.FLOAT,false,0,0);
        ctx.prog=p; return null;
    },
    render: (ctx, s, isR) => {
        if(!ctx.prog) return; const gl=ctx.gl;
        if(!s.saving){const d=window.devicePixelRatio||1, w=Math.floor(ctx.cvs.clientWidth*d), h=Math.floor(ctx.cvs.clientHeight*d); if(ctx.cvs.width!==w||ctx.cvs.height!==h){ctx.cvs.width=w;ctx.cvs.height=h;gl.viewport(0,0,w,h);}}
        gl.useProgram(ctx.prog);
        const cam=isR?s.right:s.left, u=(n,v)=>gl.uniform1f(gl.getUniformLocation(ctx.prog,n),v), uv=(n,v)=>gl.uniform2f(gl.getUniformLocation(ctx.prog,n),v[0],v[1]);
        gl.uniform1i(gl.getUniformLocation(ctx.prog,'u_pal'), s.p.pal); gl.uniform1i(gl.getUniformLocation(ctx.prog,'u_mode'), s.mode); gl.uniform1i(gl.getUniformLocation(ctx.prog,'u_view'), isR?1:0);
        uv('u_res',[ctx.cvs.width, ctx.cvs.height]); uv('u_off',[cam.x,cam.y]); uv('u_c',[s.c.x,s.c.y]);
        u('u_zoom',cam.z); u('u_iter',s.p.iter); u('u_grid',s.p.grid);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
    }
};

class NebulaRenderer {
    constructor(id){this.cvs=document.getElementById(id); this.ctx=this.cvs.getContext('2d'); this.hist=null; this.frames=0;}
    reset(){
        const d=window.devicePixelRatio||1, w=Math.floor(this.cvs.clientWidth*d), h=Math.floor(this.cvs.clientHeight*d);
        this.cvs.width=w; this.cvs.height=h; this.hist=new Float32Array(w*h*3); this.imgData=this.ctx.createImageData(w,h); this.frames=0;
    }
    renderBatch(state, isR) {
        if(!this.hist) return; const w=this.cvs.width, h=this.cvs.height, cam=isR?state.right:state.left, p=state.p;
        const vh=1.0/cam.z, vw=(w/h)*vh, minX=cam.x-vw/2, minY=cam.y-vh/2, max_i=p.iter;
        const trX=new Float32Array(max_i), trY=new Float32Array(max_i), isAtl=(state.mode===2&&isR); this.frames++;
        for(let i=0; i<20000; i++) {
            let cr, ci, zx, zy, cx, cy;
            let rx = minX + Math.random()*vw, ry = minY + Math.random()*vh;
            if(isAtl) {
                let worldScale = 1.0/(cam.z*p.grid*0.25);
                cx = (Math.floor(rx/worldScale)+0.5)*worldScale; cy = (Math.floor(ry/worldScale)+0.5)*worldScale;
                cr=cx*4.0; ci=cy*4.0; zx=(Math.random()-0.5)*3.0; zy=(Math.random()-0.5)*3.0;
            } else { if(isR){cr=state.c.x;ci=state.c.y;zx=rx*3.0;zy=ry*3.0;} else {cr=rx*4.0;ci=ry*4.0;zx=0;zy=0;} }
            let step=0, esc=false, d_min=1000.0, eq=p.eqMode;
            while(step<max_i){
                trX[step]=zx; trY[step]=zy; let nx, ny;
                if(eq===0){nx=zx*zx-zy*zy+cr; ny=2.0*zx*zy+ci;}else if(eq===1){nx=zx*zx*zx-3.0*zx*zy*zy+cr; ny=3.0*zx*zx*zy-zy*zy*zy+ci;}
                else if(eq===4){nx=zx*zx-zy*zy+cr; ny=2.0*Math.abs(zx*zy)+ci;} else {let r2=zx*zx+zy*zy; if(r2>100){esc=true;break;} let r=Math.sqrt(r2),a=Math.atan2(zy,zx),rn=Math.pow(r,2.0); nx=rn*Math.cos(a*2.0)+cr; ny=rn*Math.sin(a*2.0)+ci;}
                zx=nx; zy=ny; let m=zx*zx+zy*zy; if(m<d_min)d_min=m; if(m>100.0){esc=true;break;} step++;
            }
            if(esc && step>0) {
                let glow = Math.exp(-d_min*10.0);
                for(let s=0; s<step; s++) {
                    let twx = isAtl ? cx+(trX[s]/3.0)*(1.0/(cam.z*p.grid*0.25)) : (isR?minX+((trX[s]/3.0)+0.5)*vw : trX[s]/4.0);
                    let twy = isAtl ? cy+(trY[s]/3.0)*(1.0/(cam.z*p.grid*0.25)) : (isR?minY+((trY[s]/3.0)+0.5)*vh : trY[s]/4.0);
                    let px = Math.floor((twx-minX)/vw*w), py=Math.floor((twy-minY)/vh*h);
                    if(px>=0&&px<w&&py>=0&&py<h) { let idx=((h-1-py)*w+px)*3; if(step>p.r)this.hist[idx]+=glow; if(step>p.g)this.hist[idx+1]+=glow; if(step>p.b)this.hist[idx+2]+=glow; }
                }
            }
        }
        const data=this.imgData.data; const gain=isR?20:800, scale=(p.den*gain)/this.frames, norm=1.0/Math.log1p(gain);
        for(let i=0; i<w*h*3; i+=3) {
            data[i/3*4]=Math.min(255,Math.pow(Math.log1p(this.hist[i]*scale)*norm,1.2)*255);
            data[i/3*4+1]=Math.min(255,Math.pow(Math.log1p(this.hist[i+1]*scale)*norm,1.2)*255);
            data[i/3*4+2]=Math.min(255,Math.pow(Math.log1p(this.hist[i+2]*scale)*norm,1.2)*255); data[i/3*4+3]=255;
        }
        this.ctx.putImageData(this.imgData,0,0);
        if(!isR && state.mode!==2){const sx=(state.c.x/4.0-cam.x)/vw*w, sy=h-(state.c.y/4.0-cam.y)/vh*h; this.ctx.beginPath(); this.ctx.arc(sx,sy,5,0,Math.PI*2); this.ctx.fillStyle='#fff'; this.ctx.fill(); this.ctx.stroke();}
    }
}

// =======================================================
// APP LOGIC
// =======================================================
const app = {
    state: { mode:0, locked:false, saving:false, c:{x:-0.76,y:0.12}, left:{x:0,y:0,z:1}, right:{x:0,y:0,z:1}, p:{iter:300, grid:10, pal:0, den:1.5, r:200, g:100, b:50, eqMode:0}, drag:false, active:null, last:{x:0,y:0} },
    glCtx: [], nebCtx: [],
    init: function() {
        this.glCtx=[GL.setup('gl-left'), GL.setup('gl-right')]; this.nebCtx=[new NebulaRenderer('cpu-left'), new NebulaRenderer('cpu-right')];
        ui.init(); this.compile(); this.loop();
    },
    compile: function() {
        const raw=document.querySelector('.sync-eq-raw').value, glsl=parseEquation(raw);
        let err=null; this.glCtx.forEach(c=>{let r=GL.compile(c,glsl); if(r)err=r;});
        const log=document.getElementById('error-log'); if(err){log.style.display='block'; log.innerText=err;} else {log.style.display='none'; this.triggerReset();}
    },
    loadPreset: function(v) { document.querySelectorAll('.sync-eq-raw').forEach(i=>i.value=v); this.compile(); },
    triggerReset: function() { this.nebCtx[0].reset(); this.nebCtx[1].reset(); },
    loop: function() {
        if(!this.state.saving) {
            const m=this.state.mode;
            if(m===0){GL.render(this.glCtx[0],this.state,false); GL.render(this.glCtx[1],this.state,true);}
            else if(m===1){this.nebCtx[0].renderBatch(this.state,false); this.nebCtx[1].renderBatch(this.state,true);}
            else {GL.render(this.glCtx[0],this.state,false); this.nebCtx[1].renderBatch(this.state,true);}
        }
        requestAnimationFrame(()=>this.loop());
    },
    setMode: function(m) {
        this.state.mode=m; document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===m));
        document.getElementById('cpu-left').style.opacity = m===1?1:0;
        document.getElementById('cpu-right').style.opacity = m!==0?1:0;
        ui.updUI(); this.triggerReset();
    },
    resetPos: function() { this.state.left={x:0,y:0,z:1}; this.state.right={x:0,y:0,z:1}; this.triggerReset(); },
    save: function() {
        const view=document.getElementById('save-view').value, res=document.getElementById('save-res').value, isR=(view==='right'), useCpu=(this.state.mode===1||(this.state.mode===2&&isR));
        let tgt;
        if(useCpu) tgt=(isR?this.nebCtx[1]:this.nebCtx[0]).cvs;
        else {
            this.state.saving=true; const ctx=isR?this.glCtx[1]:this.glCtx[0]; const ow=ctx.cvs.width, oh=ctx.cvs.height;
            let w=ow, h=oh; if(res==='2'){w=1920;h=1080;}else if(res==='4'){w=3840;h=2160;}else if(res==='8'){w=7680;h=4320;}else if(res==='custom'){w=parseInt(document.getElementById('save-w').value); h=parseInt(document.getElementById('save-h').value);}
            ctx.cvs.width=w; ctx.cvs.height=h; ctx.gl.viewport(0,0,w,h); GL.render(ctx,this.state,isR); tgt=ctx.cvs;
        }
        const a=document.createElement('a'); a.download=`fractal_${Date.now()}.png`; a.href=tgt.toDataURL(); a.click();
        this.state.saving=false; ui.toggleModal(false);
    }
};

const ui = {
    init: function() {
        // HYBRID CONTROL SYNC
        const sync = (cls, key, isVal=true) => {
            const els = document.querySelectorAll('.'+cls);
            els.forEach(el => el.addEventListener('input', e => {
                const val = e.target.value;
                app.state.p[key] = parseFloat(val);
                els.forEach(o => o.value = val);
                if(isVal) document.querySelectorAll('.val-'+key+'-txt').forEach(t=>t.innerText=val);
                if(cls==='sync-pal') app.triggerReset();
            }));
        };
        sync('sync-iter','iter'); sync('sync-grid','grid'); sync('sync-red','r'); sync('sync-grn','g'); sync('sync-blu','b'); sync('sync-den','den'); sync('sync-pal','pal',false);
        
        document.querySelectorAll('.canvas-container').forEach((cont, idx) => {
            const isR = idx===1;
            const move = (clientX, clientY, isDown) => {
                const r=cont.getBoundingClientRect(), cam=isR?app.state.right:app.state.left;
                const asp=cont.clientWidth/cont.clientHeight, nx=((clientX-r.left)/cont.clientWidth-0.5)*asp, ny=-((clientY-r.top)/cont.clientHeight-0.5);
                const wx=nx/cam.z+cam.x, wy=ny/cam.z+cam.y;
                if(isDown && !isR && app.state.mode!==2 && !app.state.locked) {
                    app.state.c={x:wx*4, y:wy*4}; document.getElementById('tag-coords').innerText=`C: ${app.state.c.x.toFixed(4)}, ${app.state.c.y.toFixed(4)}`;
                } else if(app.state.drag) {
                    const dx=clientX-app.state.last.x, dy=clientY-app.state.last.y;
                    cam.x-=(dx/cont.clientHeight)/cam.z * asp; cam.y+=(dy/cont.clientHeight)/cam.z;
                }
                app.state.last={x:clientX,y:clientY}; if(app.state.mode!==0)app.triggerReset();
            };
            cont.addEventListener('dblclick', ()=>{app.state.locked=!app.state.locked; document.getElementById('tag-lock').style.display=app.state.locked?'block':'none';});
            cont.addEventListener('mousedown', e => { app.state.drag=true; app.state.active=isR?'r':'l'; app.state.last={x:e.clientX,y:e.clientY}; move(e.clientX,e.clientY,true);});
            window.addEventListener('mousemove', e => { if(app.state.drag && app.state.active===(isR?'r':'l')) move(e.clientX,e.clientY,false); });
            cont.addEventListener('wheel', e => { e.preventDefault(); const c=isR?app.state.right:app.state.left, s=parseFloat(document.querySelector('.sync-zoom-spd').value)*0.1; if(e.deltaY<0)c.z*=(1+s);else c.z/=(1+s); app.triggerReset(); });
            // Touch
            let iD=0, iZ=1;
            cont.addEventListener('touchstart', e => {
                app.state.active=isR?'r':'l';
                if(e.touches.length===1){ app.state.drag=true; app.state.last={x:e.touches[0].clientX,y:e.touches[0].clientY}; move(e.touches[0].clientX,e.touches[0].clientY,true); }
                else if(e.touches.length===2){ iD=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); iZ=(isR?app.state.right.z:app.state.left.z); }
            });
            cont.addEventListener('touchmove', e => {
                e.preventDefault();
                if(e.touches.length===1 && app.state.drag) move(e.touches[0].clientX,e.touches[0].clientY,false);
                else if(e.touches.length===2){ const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); (isR?app.state.right:app.state.left).z=iZ*(d/iD); app.triggerReset(); }
            });
        });
        window.addEventListener('mouseup',()=>app.state.drag=false); window.addEventListener('touchend',()=>app.state.drag=false);
    },
    toggleSettings: () => document.getElementById('settings-menu').classList.toggle('open'),
    toggleModal: (s) => document.getElementById('save-modal').style.display=s?'flex':'none',
    checkCustom: () => document.getElementById('custom-res').classList.toggle('hidden', document.getElementById('save-res').value!=='custom'),
    updUI: () => {
        const m=app.state.mode, s=(c,v)=>document.querySelectorAll('.'+c).forEach(e=>e.classList.toggle('hidden',!v));
        s('grp-neb', m!==0); s('grp-std', m===0); s('grp-atlas', m===2);
    }
};
window.onload = () => app.init();
</script>
</body>
</html>
